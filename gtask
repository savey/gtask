#!/bin/bash

#eg: åˆ›å»º featureåˆ†æ”¯ gtask -c f
#eg  åˆ›å»º hotfix åˆ†æ”¯ gtask -c h

#æ˜¯å¦åˆ›å»º hotfix
HOTFIX=0
#æ˜¯å¦åˆ›å»º feature
FEATURE=0
#ä»»åŠ¡å
TASKNAME=
#ä»»åŠ¡æ—¥æœŸ
TASKDATA=
#æ˜¯å¦åˆå¹¶ TODO
MERGE=0

#ä½¿ç”¨è¯´æ˜
usage()
{
	cat <<EOF
usage:   gtask -<option>
options:
-c [hf]
	h "åˆ›å»ºä¸€ä¸ª hotfix åˆ†æ”¯"
	f "åˆ›å»ºä¸€ä¸ª feature åˆ†æ”¯"
-d  	"åˆ é™¤æœ¬åœ°é[master\develop\dev]åˆ†æ”¯"
-m  	"åˆå¹¶å½“å‰åˆ†æ”¯åˆ°[master|develop] è¯¥æŒ‡ä»¤ä¼šæ£€æµ‹ä½ çš„æœ¬åœ°æ˜¯å¦æœ‰[master|develop]åˆ†æ”¯ã€å¦‚æœæ²¡æœ‰ã€åˆ™æ‹‰å–è¿œç¨‹çš„[master|develop]åˆ°æœ¬åœ°ï¼Œæ²¡æœ‰åˆ™é€€å‡ºï¼"

EOF

	exit 1
}

#åˆ¤æ–­å‚æ•°
if [[ $# -eq 0 ]]; then
	usage
fi


#ç”Ÿæˆå½“å‰æ—¥æœŸ
gen_date()
{
	TASKDATA=`date +%Y%m%d`
	return $?
}

#è¾“å…¥taskå
gen_name()
{	
	read -p "Your Task name:  " TASKNAME
	return $?
}

# åˆ›å»ºä»»åŠ¡
create_task()
{
	gen_date
	gen_name

	local temp="${1}/${TASKDATA}-${TASKNAME}"

	if [[ $1 == "hotfix" ]]; then
		git pull origin master:master>/dev/null 2>&1
		wait
		git checkout master>/dev/null 2>&1
	elif [[ $1 == "feature" ]]; then
		git pull origin develop:develop>/dev/null 2>&1
		wait
		git checkout develop>/dev/null 2>&1
	else
		usage
	fi

	wait
	git checkout -b ${temp}>/dev/null 2>&1


	if [[ $? == 0 ]]; then
		echo -e "ğŸ» Success created task: \033[32m${temp}\033[0m"
	else
		echo -e "ğŸ’Š failure!"
	fi

	return $?
}


while getopts "c:m:d" opt; do
	case $opt in
		c)
			if [[ $OPTARG == "h" ]]; then
				HOTFIX=1
			elif [[ $OPTARG == "f" ]]; then
				FEATURE=1
			else
				usage
			fi;;
		m)
			MERGE=1;;
		d)
			read -p "Are You Sure?[y/n]" -s tag
			if [[ $tag == "y" ]]; then
				git checkout master && git branch | egrep -v "master|dev|test" | awk '{cmd="git branch -D "$1; system(cmd)}'
			fi
			exit 1;;
		\?)
			usage;;
	esac
done

# åˆ›å»º hotfix åˆ†æ”¯
[ $HOTFIX -eq 1 ] && create_task hotfix
# åˆ›å»º feature åˆ†æ”¯
[ $FEATURE -eq 1 ] && create_task feature
