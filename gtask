#!/bin/bash

#ä»»åŠ¡å
TASKNAME=
#ä»»åŠ¡æ—¥æœŸ
TASKDATA=


#ç”Ÿæˆå½“å‰æ—¥æœŸ
gen_date()
{
	TASKDATA=`date +%Y%m%d`
	return $?
}

#è¾“å…¥taskå
gen_name()
{	
	read -p "Your Task name(${1}):  " TASKNAME
	return $?
}

# åˆ›å»ºä»»åŠ¡
create_task()
{
	gen_date
	gen_name $1

	local temp="${1}/${TASKDATA}-${TASKNAME}"

	if [ "$1" = "hotfix" ]; then
		git pull origin master:master>/dev/null 2>&1
		wait
		git checkout master>/dev/null 2>&1
	elif [ "$1" = "feature" ]; then
		git pull origin develop:develop>/dev/null 2>&1
		wait
		git checkout develop>/dev/null 2>&1
	else
		usage
	fi

	wait
	git checkout -b ${temp}>/dev/null 2>&1


	if [ $? -eq 0 ]; then
		echo -e "ğŸ» Success created task: \033[32m${temp}\033[0m"
	else
		echo -e "ğŸ’Š failure!"
	fi

	return $?
}


#æ·»åŠ æ–‡ä»¶
add_task()
{
	local filelist
	if [ -z "$1" ]; then

		filelist=`git status --porcelain --u | sed 's/^...//g'`

		[ -z "$filelist" ] && printf "æœªå‘ç°ä¿®æ”¹çš„æ–‡ä»¶ï¼\n" && exit 1
	else
		filelist=$1	
	fi

	echo -e "\033[33m==>\033[1m \033[37m Check Php Syntax... \033[0m"

	local pass=0
	for file in $filelist; do
		if [ -f "$file" ] && [ "${file##*.}s" = "phps" ]; then

			local errortips;

			`php -l $file >/dev/null 2>/tmp/php_error.log`

			[ "$?" -gt 0 ] \
			&& pass=1 \
			&& errortips=$(cat /tmp/php_error.log) \
			&& echo -e "\033[32m${file}\033[0m\033[31m âœ˜\033[0m" \
			&& echo -e "\033[41;37m${errortips}\033[0m" \
			|| echo -e "\033[32m${file}\033[0m\033[32m âœ”\033[0m"
		fi
	done

	[ $pass -eq 1 ] && echo -e "\033[33m==>\033[1m \033[37m Please Fix ! \033[0m" && exit 1

	git add $filelist

	echo -e "\033[33m==>\033[1m \033[37m Success...ğŸ¤™ğŸ¤™ğŸ¤™  \033[0m"

  return $?
}

#ä½¿ç”¨è¯´æ˜
usage()
{
	cat <<EOF
usage:   gtask [options]
options:
-s          "git status"
-c [h|f]
	    h "åˆ›å»ºä¸€ä¸ª hotfix åˆ†æ”¯ base master"
	    f "åˆ›å»ºä¸€ä¸ª feature åˆ†æ”¯ base develop"
-d    "åˆ é™¤æœ¬åœ°é[master\develop\dev]åˆ†æ”¯  æ³¨æ„ï¼šå½“ä½¿ç”¨æ­¤é€‰é¡¹æ—¶ã€å…¶ä»–é€‰é¡¹ä¸ç”Ÿæ•ˆ"
-a|--add    "--add=<file>. æ·»åŠ åˆ°æš‚å­˜åŒº,å¹¶ä¸”æ£€æµ‹phpè¯­æ³•é”™è¯¯ï¼é»˜è®¤ä¸ºå…¨éƒ¨æ”¹åŠ¨ï¼Œä½†å¯ä»¥æ·»åŠ ä¸€ä¸ªæŒ‡å®šæ–‡ä»¶ã€æ³¨æ„ï¼š å½“ä½¿ç”¨æ­¤é€‰é¡¹æ—¶ã€å…¶ä»–é€‰é¡¹ä¸ç”Ÿæ•ˆ"
-m|--msg    "--msg=<msg>æäº¤ä»£ç åˆ°ä»“åº“ å¿…è·Ÿå‚æ•° message"

EOF

	exit 0
}

#åˆ¤æ–­å‚æ•°
[ "$#" -eq 0 ] && usage

args=`getopt -o m::a::c:sdh --long add::,msg::,status -n "$0" -- "$@"`

eval set -- "$args"

while true; do
	case $1 in
		-s | --status)
			git status
			exit 0
			;;
	  	-m | --msg)
		    [ -z $2 ] && msg=fixbug || msg=$2
		    eval git commit -m $2
		    exit
	    	;;
	  	-h )
		    usage
		    shift
		    ;;
		-c )
			case $2 in
				f )
					create_task feature
					;;
				h )
					create_task hotfix
					;;
				fh | hf )
					create_task feature
					create_task hotfix
					;;
				* )
					usage

			esac
			exit 0
			;;
		-a | --add)
			add_task $2
			exit $?
			;;
		-d)
			read -p "Are You Sure?[y/n]" -s tag
			if [ $tag = "y" ]; then
				git checkout master && git branch | egrep -v "master|dev|test" | awk '{cmd="git branch -D "$1; system(cmd)}'
			fi
			exit 1;;
	  --)
	    shift
	    exit
	    ;;
	\?)
	    usage
		  exit
			;;
	esac
done
