#!/bin/bash

#ä»»åŠ¡å
TASKNAME=
#ä»»åŠ¡æ—¥æœŸ
TASKDATA=

#git æ‰§è¡Œæ–‡ä»¶
GITPATH="/usr/bin/git"
#phpè§£é‡Šå™¨
PHPBIN="/usr/bin/env php -l"
# phpcs æ£€æŸ¥åˆ°çš„é”™è¯¯ä¿¡æ¯
PHPCSLOGFILE=/tmp/check_result.txt
#php è¯­æ³•é”™è¯¯æ—¥å¿—æ–‡ä»¶
PHPERRORFILE=/tmp/php_error.log
#phpcs æ‰§è¡Œ
PHPCS="phpcs --standard=OSR0 --colors --encoding=utf-8 -n -p"
#gun-opt
GUNOPT="/usr/bin/env getopt"

FORMATSTUDIO="\033[37m|----------------------------------------------------------------------|\033[0m"

# ä¸€ä¸ªä¿å­˜æœ¬åœ°åˆ†æ”¯çš„æ•°ç»„
LOCALBRANCHS=

#é€‰ä¸­çš„åˆ†æ”¯
SELECTBRANCH=

# ä¸å¸¦å‚æ•°æ—¶å‡ºç°é€‰é¡¹ï¼Œ
# å¸¦å‚æ•°æ—¶ï¼ŒæŒ‡å®šæŠŠæŸä¸ªç´¢å¼•åˆ†æ”¯ merge åˆ° æŒ‡å®šç´¢å¼•åˆ†æ”¯
run_merge_branc()
{
	if [[ $1 = "abort" ]]; then
	    eval $GITPATH merge --abort
	    return $?
	fi

	select_branch $1

	eval exec $GITPATH merge $SELECTBRANCH
}




#åˆ—è¡¨å‡ºå½“å‰gitä¸‹æœ¬åœ°æ‰€æœ‰åˆ†æ”¯ã€å¹¶å¸¦ä¸Šç´¢å¼•ä½ç½®
#gt -b
ls_git_local_branch()
{

	select_branch $1

	eval exec $GITPATH checkout $SELECTBRANCH
}

show_local_branch()
{
	build_array_branch

	#å½“å‰åˆ†æ”¯
	local currentBranch=`eval $GITPATH branch | grep "^*" | cut -d " " -f 2`

	for (( i = 1; i < ${#LOCALBRANCHS[@]}; i++ )); do
		local selectBranchName=${LOCALBRANCHS[i]}
		local branchDesc=`eval $GITPATH config branch.$selectBranchName.description`
		
		[[ $selectBranchName = $currentBranch ]] \
		&& branchSelc="\033[32;40;5m [$i] - ${selectBranchName}\033[0m" \
		|| branchSelc="\033[32m [$i] - ${selectBranchName}\033[0m"
		
		[[ -n $branchDesc ]] && branchSelc="${branchSelc}   #desc:${branchDesc}"

		echo -e $branchSelc
	done
	
	return $?
}


# é€‰æ‹©åˆ†æ”¯
select_branch()
{	
	if [[ -z $1 ]]; then

		show_local_branch
		
		while [[ -z $SELECTBRANCH ]]; do
			read -ep "Select Your Branch Index: " index
			SELECTBRANCH=${LOCALBRANCHS[index]}
		done

	else
		
		if [[ $1 =~ ^[0-9]+$ ]]; then

			SELECTBRANCH=${LOCALBRANCHS[$1]}

			if [[ -z $SELECTBRANCH ]]; then
				echo "Please Select Branch Index"
				exit 1
			fi
		else
			SELECTBRANCH=$1
		fi

	fi

	return $?
}




# git branch åˆ†æ”¯æ”¾åˆ°æ•°ç»„é‡Œ
build_array_branch()
{
	local i=1

	for b in `eval $GITPATH branch | grep "" | sed -e 's/*/ /' -e 's/ //'`; do LOCALBRANCHS[$i]=$b; let i++; done;

	return $?
}


#ç”Ÿæˆå½“å‰æ—¥æœŸ
gen_date()
{
	TASKDATA=`date +%Y%m%d`
	return $?
}

#è¾“å…¥taskå
gen_name()
{	
	read -p "Your Task name(${1}):  " TASKNAME
	return $?
}

# åˆ›å»ºä»»åŠ¡
create_task()
{
	gen_date
	gen_name $1

	local temp="${1}/${TASKDATA}-${TASKNAME}"

	if [[ "$1" = "hotfix" ]]; then
		eval $GITPATH pull origin master:master
		eval $GITPATH checkout master
	elif [[ "$1" = "feature" ]]; then
		eval $GITPATH pull origin develop:develop
		eval $GITPATH checkout develop
	else
		usage
	fi

	eval $GITPATH checkout -b ${temp}

	if [[ $? -eq 0 ]]; then
		echo -e "ğŸ» Success created task: \033[32m${temp}\033[0m"
	else
		echo -e "ğŸ’Š failure!"
	fi
	
	return $?
}


#æ·»åŠ æ–‡ä»¶
add_task()
{
	local filelist
	if [[ -z "$1" || $1 = "." ]]; then

		filelist=`eval $GITPATH status --porcelain --u | sed 's/^...//g'`

		[[ -z "$filelist" ]] && printf "æœªå‘ç°ä¿®æ”¹çš„æ–‡ä»¶ï¼\n" && exit 1
	else
		filelist=$1	
	fi

	echo -e $FORMATSTUDIO
	echo -e "\033[37m|                         PHPè¯­æ³•æ£€æµ‹å¼€å§‹                              |\033[0m\n"

	local pass=0
	local errortips

	for file in $filelist; do
		if [[ -f "$file" && "${file##*.}s" = "phps" ]]; then
			eval $PHPBIN $file >/dev/null 2>$PHPERRORFILE

			[[ "$?" -gt 0 ]] \
			&& pass=1 \
			&& errortips=$(cat $PHPERRORFILE) \
			&& echo -e "\t\033[32m${file}\033[0m\033[31m âœ˜\033[0m" \
			&& echo -e "\t\033[41;37m${errortips}\033[0m" \
			|| echo -e "\t\033[32m${file}\033[0m\033[32m âœ”\033[0m"

			phpcsLog=`eval $PHPCS $file`

			if [[ ${phpcsLog:0:1} != "." ]]; then
				echo "$phpcsLog" >> $PHPCSLOGFILE
			fi

		fi
	done
	# test 
	if [[ $pass -eq 1 ]]; then
		#
		echo "" > $PHPCSLOGFILE
		echo -e "\n\033[37m|              å½“å‰æäº¤PHPæ–‡ä»¶æœ‰è¯­æ³•é”™è¯¯ã€æäº¤å¤±è´¥                     |\033[0m"
		echo -e "\033[37m|----------------------------------------------------------------------|\033[0m"
		exit 1
	fi
	echo -e "\n\033[37m|                         PHPè¯­æ³•æ£€æµ‹é€šè¿‡                              |\033[0m"
	# test psr
	echo -e "\033[37m|----------------------------------------------------------------------|\033[0m"
	echo -e "\033[37m|                         PHPCSæ£€æµ‹å¼€å§‹                                |\033[0m"

	if [[ -s $PHPCSLOGFILE ]]; then
		cat $PHPCSLOGFILE && rm $PHPCSLOGFILE
		echo -e "\n\033[37m|                  è¯·ä¿®å¤ä»£ç æ ¼å¼!gitæäº¤å¤±è´¥                            \033[0m"
		echo -e "\033[37m|----------------------------------------------------------------------\033[0m"
		exit 1
	fi
	echo -e "\n\033[37m|                   æœªæ£€æµ‹åˆ°æ ¼å¼é”™è¯¯çš„PHPæ–‡ä»¶                          \033[0m"
	echo -e "\033[37m|----------------------------------------------------------------------|\033[0m"

	eval $GITPATH add $filelist

	echo -e "\033[33m[SUCCESS]\033[1m \033[37m \t\tgitæäº¤æˆåŠŸ...ğŸ¤™ğŸ¤™ğŸ¤™  \033[0m"

  return $?
}


push_pull()
{
	case $1 in
		l)
	  		eval $GITPATH pull
	   		;;
		s)
			eval $GITPATH push
			;;
		sf)
			eval $GITPATH push -f
			;;
		*)
			echo -e "The Options -p Only Support l or s!"
			;;
	esac
}

#åˆ é™¤åˆ†æ”¯
del_branch() {
	if [[ $1 = "all" ]]; then
		read -p "Are You Sure?[y/n]" -s tag
		if [[ $tag = "y" ]]; then
			exec eval $GITPATH checkout master && $GITPATH branch | egrep -v "master|dev|test" | awk '{cmd="git branch -D "$1; system(cmd)}'
		fi
	fi

	select_branch

	eval exec $GITPATH br -D $SELECTBRANCH
}


#ä½¿ç”¨è¯´æ˜
usage()
{
	echo -e "
\033[1;37mUSAGE \033[0m  [<options...>]

\033[1;37mOPTIONS\033[0m:
-b 
    æŸ¥çœ‹æœ¬åœ°æ‰€æœ‰åˆ†æ”¯
-s
    æ‰§è¡Œ git status

-c [<mode>]
    h åˆ›å»ºä¸€ä¸ª hotfix åˆ†æ”¯ åŸºäº master æ‰€ä»¥æœ¬åœ°è¦æœ‰ master åˆ†æ”¯
    f åˆ›å»ºä¸€ä¸ª feature åˆ†æ”¯ åŸºäº develop æ‰€ä»¥æœ¬åœ°è¦æœ‰ develop åˆ†æ”¯

-d [<index>]
    index=all æ—¶åˆ é™¤æœ¬åœ°é[master\develop\dev]åˆ†æ”¯  æ³¨æ„ï¼šå½“ä½¿ç”¨æ­¤é€‰é¡¹æ—¶ã€å…¶ä»–é€‰é¡¹ä¸ç”Ÿæ•ˆ

-a|--add
    --add=<file>. æ·»åŠ åˆ°æš‚å­˜åŒº,å¹¶ä¸”æ£€æµ‹phpè¯­æ³•é”™è¯¯ï¼é»˜è®¤ä¸ºå…¨éƒ¨æ”¹åŠ¨ï¼Œä½†å¯ä»¥æ·»åŠ ä¸€ä¸ªæŒ‡å®šæ–‡ä»¶ã€æ³¨æ„ï¼š å½“ä½¿ç”¨æ­¤é€‰é¡¹æ—¶ã€å…¶ä»–é€‰é¡¹ä¸ç”Ÿæ•ˆ
    gtask -a .
    gtask -a file

-m|--msg [<message>]
    é»˜è®¤ message=fixbug æäº¤ä»£ç åˆ°ä»“åº“ å¿…è·Ÿå‚æ•° message
    gtask -mbugæäº¤

--co [<index>]
    ä¼šå‡ºç°æœ¬åœ°å¯ä»¥åˆ‡æ¢çš„åˆ†æ”¯ã€index å¯ä»¥æŸä¸€ä¸ªåˆ†æ”¯çš„ç´¢å¼•ä½ç½®ï¼Œç›´æ¥åˆ‡åˆ°è¯¥é€‰ä¸­åˆ†æ”¯ 
    gtask --co ä¼šåˆ—è¡¨æ‰€æœ‰å¯åˆ‡æ¢åˆ†æ”¯
    gtask --co 1 ä¼šåˆ‡æ¢åˆ° 1å¯¹åº”çš„åˆ†æ”¯

--merge [<index>]
	åŒ --co ä¸€æ ·çš„ç”¨æ³•ï¼ŒæŠŠæŒ‡å®šåˆ†æ”¯åˆå¹¶åˆ°å½“å‰æ‰€åœ¨åˆ†æ”¯ æ”¯æŒ abort

-p [l|s|sf]
    l git pull
    s git push
    sf git push --force
"
	exit 0
}

#åˆ¤æ–­å‚æ•°
[[ "$#" -eq 0 ]] && usage

args=`eval $GUNOPT -o p:m:a:c:dbsh -l merge,co,add:,msg:,status -- $*`


eval set -- "${args}"


while true; do
	case $1 in
		-b)
			show_local_branch
			exit 0
			;;
		-p)
			shift
			push_pull $1
			exit 0
			;;
		-s | --status)
			eval $GITPATH status
			exit 0
			;;
	  	-m | --msg)
		    [[ ! -n $2 ]] && msg=fixbug || msg=$2
		    eval $GITPATH commit -m $2
		    exit 0
	    	;;
	  	-h )
		    usage
		    shift
		    ;;
		-c )
			case $2 in
				f )
					create_task feature
					;;
				h )
					create_task hotfix
					;;
				hf|fh )
					create_task feature
					create_task hotfix
					;;
				* )
					usage
					exit 0

			esac
			exit 0
			;;
		-a | --add)
			add_task $2
			exit 0
			;;
		-d)
			shift
			del_branch $2
			exit 0
			;;
		--co)
			shift
			ls_git_local_branch $2
			exit 0
			;;
		--merge)
			shift
			run_merge_branc $2
			exit 0
			;;
	  --)
		usage
		exit $?
	    ;;
	\?)
	    usage
		exit $?
		;;
	esac
done
